#summary การประยุกต์ใช้ Perl 2
<table width=500>
<td>
[CourseSchedule2555_2 กลับไปหน้าหลัก]-->[<a href="https://code.google.com/p/system-programming-cs3402-at-crma/wiki/CourseSchedule2555_2#ตารางเรียน_๒๕๕๕/๒">ตารางเรียน</a>]-->Next: [cReview ทบทวนภาษา C]
<wiki:toc max_depth="3" />

=สร้างกราฟการใช้ memory จาก sar=
จากตัวอย่างที่ผ่านมาเราสามารถนำมาประยุกต์ใช้สร้างกราฟสถิติจาก sar ได้อีกเช่นในกรณีนี้หากเรารันคำสั่ง sar -r จะได้ผลการรันดังนี้ 
{{{
prachya@pcubusrv104> sar -r

Linux  pcubusrv104  2.6.32-33-generic-pae  #70-Ubuntu SMP Thu Jul 7 22:51:12 UTC 2011  i686  11/14/2012

00:00:01  memtot memfree buffers   cached  slabmem      swptot swpfree  _mem_
00:10:01    488M     68M    184M     165M      32M        976M    976M
00:20:01    488M     68M    184M     165M      32M        976M    976M
00:30:01    488M     68M    184M     165M      32M        976M    976M
}}}
จะเห็นได้ว่าเครื่องมีหน่วยความจำ 488M และ หน่วยความจำเหลือ memfree=68M (เปลี่ยนไปตามเวลา) มีส่วนที่เป็น buffers และ ส่วนที่เป็น virtual memory หรือ swap ในที่นี้เราจะ plot การใช้งานหน่วยความจำที่ใช้, หน่วยความจำที่เหลือ, และ buffers

เราจะใช้โค้ดเดียวกันกับ gchart-disk.pl โดยแก้ไขบางส่วนที่เกี่ยวข้องกับการใช้หน่วยความจำ และเราเลือกใช้ AreaChart ตามตัวอย่างใน [http://code.google.com/apis/ajax/playground/?type=visualization#area_chart Google Chart]

{{{
# gchart-mem.pl
# written by Prachya Chalermwat, Ph.D. Mail: pyavinci@gmail.com
# Nov 14, 2012
print "<html xmlns=\"http://www.w3.org/1999/xhtml\">\n";
print "  <head>\n";
print "    <meta http-equiv=\"content-type\" content=\"text/html; charset=utf-8\"/>\n";
print "    <title>\n";
print "      Google Visualization API Sample\n";
print "    </title>\n";
print "    <script type=\"text/javascript\" src=\"http://www.google.com/jsapi\"></script>\n";
print "    <script type=\"text/javascript\">\n";
print "      google.load('visualization', '1', {packages: ['corechart']});\n";
print "    </script>\n";
print "    <script type=\"text/javascript\">\n";
print "      function drawVisualization() {\n";
print "        // Some raw data (not necessarily accurate)\n";
print "        var data = google.visualization.arrayToDataTable([\n";
print "          ['Time',   'Used', 'free', 'buffer'],\n";
system("sar -r > tmp.dat");
open FILE, "<", "tmp.dat" or die $!;
$i=0;
foreach $buf (<FILE>) {
  $buf =~s/[ \t\n]+/;/g ; # get rid of white spaces/tab and put ; instead
  if ($i>5) {
    $x=@col=split(/;/,$buf);
    $tstamp=$col[0];  $tstamp=~s/[ \t]+//g;
    $total=$col[1];  $total=~s/M//g;
    $free=$col[2];  $free=~s/M//g;
    $buffer=$col[3]; $buffer=~s/M//g;
    my $used=$total-$free;
    if ($total!=0) { # get rid of error lines
    print "          [\'$tstamp\', $used,   $free,       $buffer],\n";
    }
  }
  $i++;
}
print "        ]);\n";
print "        // Create and draw the visualization.\n";
print "        var ac = new google.visualization.AreaChart(document.getElementById('visualization'));\n";
print "        ac.draw(data, {\n";
print "          title : 'Memory Usage',\n";
print "          isStacked: true,\n";
print "          width: 600,\n";
print "          height: 400,\n";
print "          vAxis: {title: \"MB\"},\n";
print "          hAxis: {title: \"Time\"}\n";
print "        });\n";
print "      }\n";
print "      \n";
print "\n";
print "      google.setOnLoadCallback(drawVisualization);\n";
print "    </script>\n";
print "  </head>\n";
print "  <body style=\"font-family: Arial;border: 0 none;\">\n";
print "    <div id=\"visualization\" style=\"width: 600px; height: 400px;\"></div>\n";
print "  </body>\n";
print "</html>\n";
}}}

เมื่อรันด้วยคำสั่งต่อไปนี้จะได้หน้า [http://10.134.64.45/prachya/perl/t6.html  t6.html] ซึ่งแสดงกราฟแบบพื้นที่ ข้อมูลการใช้งานหน่วยความจำของเครื่องเซอร์ฟเวอร์
{{{
perl gchart-mem.pl > t6.html
}}}

==อธิบายการแก้ไขโค้ด==
โค้ดในส่วนนี้ได้รับการแก้ไขให้อ่านข้อมูล จากการรัน sar -r แล้วเก็บไว้ในไฟล์ tmp.dat จากนั้นก็เปิดไฟล์เพื่ออ่านด้วยคำสั่ง open โดยใช้ตัวแปร FILE เป็น file handler ตั้งค่าบรรทัด i=0 ก่อนเข้าลูปของการอ่านแต่ละบรรทัด ด้วยคำสั่ง {{{foreach $buf (<FILE>)}}}  เมื่ออ่านเข้ามาแล้วก็กำจัดช่องว่างและแทนที่ด้วยตัวคั่นในที่นี้ใช้เซมิโคล่อน (;) โดยกระทำทั้งหมดในคำสั่ง {{{$buf =~s/[ \t\n]+/;/g ;}}} 

เงื่อนไข {{{ if ($i>5) {}}} จะทำการข้ามหัวของรายงานไปประมาณ 4 บรรทัด จากนั้นแปลง buf ให้เป็นอาเรย์โดยใช้คำสั่ง split ในบรรทัด {{{ $x=@col=split(/;/,$buf);}}} แล้วทำการแยกตัวแปรที่ต้องการ ในที่นี้มี tstamp, total, free, และ buffer เสร็จแล้วคำนวณ used จากค่าของ total-free แล้วพิมพ์ออกมาให้อยู่ในรูปแบบข้อมูลของ Google Code
{{{
system("sar -r > tmp.dat");
open FILE, "<", "tmp.dat" or die $!;
$i=0;
foreach $buf (<FILE>) {
  $buf =~s/[ \t\n]+/;/g ; # get rid of white spaces/tab and put ; instead
  if ($i>5) {
    $x=@col=split(/;/,$buf);
    $tstamp=$col[0];  $tstamp=~s/[ \t]+//g;
    $total=$col[1];  $total=~s/M//g;
    $free=$col[2];  $free=~s/M//g;
    $buffer=$col[3]; $buffer=~s/M//g;
    my $used=$total-$free;
    if ($total!=0) { # get rid of error lines
    print "          [\'$tstamp\', $used,   $free,       $buffer],\n";
    }
  }
  $i++;
}
}}}
<img width=400 src="https://dl.dropbox.com/u/37142998/2012%20System%20Programming/Figures/%E0%B8%A3%E0%B8%B9%E0%B8%9B%E0%B8%A0%E0%B8%B2%E0%B8%9E4.png">

=References=
  # Wiil-Hans Steeb, et al, _Linux, Shell Programming and Perl_ [http://issc.uj.ac.za/downloads/linux.pdf  PDF]
----
[CourseSchedule2555_2 กลับไปหน้าหลัก]-->[<a href="https://code.google.com/p/system-programming-cs3402-at-crma/wiki/CourseSchedule2555_2#ตารางเรียน_๒๕๕๕/๒">ตารางเรียน</a>]-->Next: [cReview ทบทวนภาษา C]

[https://code.google.com/p/system-programming-cs3402-at-crma/w/edit/perlProgApp2 Edit]